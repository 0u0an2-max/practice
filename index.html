<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëª¨ë¹„ìŠ¤ ë„íŠ¸ ë¡œë“œ: KBL ì–¼í‹°ë°‹ ì±”í”¼ì–¸ì‹­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+KR:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            overflow: hidden;
            touch-action: none; 
            user-select: none;
        }

        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .font-title { font-family: 'Noto Sans KR', sans-serif; font-weight: 900; }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background-color: #d29145;
            overflow: hidden;
            image-rendering: pixelated;
        }

        #game-canvas {
            display: block;
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.92);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 100;
            pointer-events: auto;
        }

        .btn-retro {
            background: #e30613;
            border: 4px solid #000;
            box-shadow: 4px 4px 0px #000;
            transition: all 0.1s;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 280px; 
            height: 56px;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 1rem;
        }
        .btn-retro:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        .profile-card {
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%);
            border: 4px solid #000;
            color: #000;
            border-radius: 4px;
        }

        .quiz-option {
            background: #fff;
            border: 3px solid #000;
            color: #000;
            padding: 12px;
            margin: 6px;
            cursor: pointer;
            width: 100%;
            text-align: center;
            font-weight: 900;
            font-size: 16px;
        }
        .quiz-option:hover { background: #f0f0f0; }

        @keyframes hit-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .hit-effect { animation: hit-shake 0.2s 3; }

        #lives-bar {
            display: flex;
            gap: 6px;
        }

        .pause-btn {
            background: rgba(0,0,0,0.6);
            border: 2px solid white;
            color: white;
            padding: 5px 12px;
            font-weight: 900;
            pointer-events: auto;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="game-canvas"></canvas>

        <!-- ìƒë‹¨ UI -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-start z-10 pointer-events-none text-white">
            <div class="flex flex-col space-y-2 text-white">
                <div class="bg-black/80 border-2 border-white p-2 flex items-center space-x-2">
                    <div id="lives-bar"></div>
                </div>
                <div class="bg-black/80 border-2 border-white p-2">
                    <h1 class="text-[9px] pixel-font text-yellow-400 uppercase">Lv.<span id="current-level">1</span></h1>
                    <div class="text-[9px] mt-1 pixel-font uppercase">Dist:<span id="current-score">0</span>m</div>
                </div>
            </div>
            <div class="flex flex-col items-end space-y-2 text-white">
                <div class="text-right bg-black/80 border-2 border-white p-2 min-w-[140px]">
                    <div class="text-yellow-300 text-[9px] pixel-font uppercase">Total MP:<span id="total-mp-display">0</span></div>
                    <div id="shot-clock-bar" class="w-full h-2 bg-gray-700 mt-1 border border-white overflow-hidden">
                        <div id="shot-clock-inner" class="h-full bg-red-600 w-full transition-all duration-100"></div>
                    </div>
                </div>
                <button onclick="togglePause()" class="pause-btn uppercase text-[10px]">ì¼ì‹œì •ì§€ ||</button>
            </div>
        </div>

        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="overlay-start" class="overlay text-center">
            <div id="player-preview-canvas-container" class="mb-4 bg-white border-4 border-yellow-400 p-2 shadow-2xl">
                <canvas id="preview-canvas" width="80" height="80"></canvas>
            </div>
            <h2 class="text-4xl font-title mb-4 text-yellow-400 tracking-tighter uppercase text-white">ëª¨ë¹„ìŠ¤ ë„íŠ¸ ë¡œë“œ</h2>
            
            <div class="bg-black/40 p-4 mb-8 rounded border border-white/20 w-72 mx-auto text-white">
                <p class="text-sm text-yellow-300 font-bold uppercase">ìµœê³  ê¸°ë¡: <span id="best-dist">0</span>m</p>
                <p id="collect-count-display" class="text-[10px] text-white/70 uppercase mt-1">ë¡œìŠ¤í„° ìˆ˜ì§‘: 0/26</p>
            </div>

            <div class="flex flex-col space-y-4">
                <button onclick="startGame()" class="btn-retro text-white">ê²½ê¸° ì‹œì‘</button>
                <button onclick="switchTab('collection')" class="btn-retro bg-blue-600 text-white">ë¡œìŠ¤í„° í™•ì¸</button>
                <button onclick="switchTab('shop')" class="btn-retro bg-green-600 text-white text-white">ì˜ì… & ìƒì </button>
            </div>
            
            <p class="mt-8 text-center text-gray-400 px-10 leading-relaxed text-[8px] pixel-font uppercase text-white">
                ìœ„ë¡œ ë°€ë©´ ì „ì§„! í•˜íŠ¸ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥!<br>3 LIVES & ALL KBL RIVALS
            </p>
        </div>

        <!-- í€´ì¦ˆ ì˜¤ë²„ë ˆì´ -->
        <div id="overlay-quiz" class="overlay hidden">
            <div class="bg-white border-[6px] border-black p-8 w-80 text-black text-center shadow-[12px_12px_0px_#000]">
                <h3 class="font-title text-xl text-red-600 mb-6 uppercase text-black">ëª¨ë¹„ìŠ¤ íŒ¬ í€´ì¦ˆ!</h3>
                <p id="quiz-question" class="font-bold text-lg mb-8 leading-tight text-black"></p>
                <div id="quiz-options" class="flex flex-col space-y-2 text-black"></div>
                <div id="quiz-feedback" class="mt-4 font-bold text-lg hidden text-black"></div>
                <button id="quiz-next-btn" onclick="moveToClearScreen()" class="mt-6 w-full h-12 bg-black text-white font-bold hidden uppercase text-white">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>

        <!-- ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ -->
        <div id="overlay-pause" class="overlay hidden">
            <h2 class="text-5xl font-title text-yellow-400 mb-10 uppercase italic">Paused</h2>
            <button onclick="togglePause()" class="btn-retro bg-white text-black text-xl mb-6 text-black">ê³„ì†í•˜ê¸°</button>
            <button onclick="location.reload()" class="btn-retro bg-gray-600 text-white text-sm">ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <!-- ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ -->
        <div id="overlay-clear" class="overlay hidden">
            <h2 class="text-5xl font-title text-yellow-400 uppercase italic mb-4 text-center">Goal Success!</h2>
            <div class="bg-black border-4 border-white p-6 mb-8 text-center w-80 backdrop-blur-sm text-white text-white">
                <p class="text-xl font-bold mb-2 uppercase text-white">Stage Cleared!</p>
                <p id="clear-stats" class="text-sm font-bold text-gray-300"></p>
            </div>
            <div class="flex flex-col space-y-3">
                <button onclick="buyLife('clear')" class="btn-retro bg-pink-500 text-white text-sm font-bold">ìƒëª… 1ê°œ êµ¬ë§¤ (200 MP)</button>
                <button onclick="scoutPlayer('clear')" class="btn-retro bg-yellow-400 text-black text-sm font-bold">ì„ ìˆ˜ ìŠ¤ì¹´ìš°íŠ¸</button>
                <button onclick="continueGame()" class="btn-retro bg-white text-black text-sm font-bold">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>

        <!-- ê²Œì„ ì˜¤ë²„ -->
        <div id="overlay-over" class="overlay hidden">
            <h2 class="text-6xl font-title mb-6 text-red-500 uppercase italic text-center text-white text-white">Game Over</h2>
            <div class="bg-black border-4 border-white p-6 mb-8 text-center w-80 backdrop-blur-sm text-white text-white">
                <p id="final-stats" class="text-lg font-bold leading-loose uppercase text-white"></p>
            </div>
            <div class="flex flex-col space-y-4 text-white">
                <button onclick="resetGame()" class="btn-retro bg-white text-black text-sm text-black font-bold">ë‹¤ì‹œ ë„ì „</button>
                <button onclick="switchTab('collection')" class="btn-retro bg-blue-600 text-white text-sm font-bold">ì„ ìˆ˜ ì„ íƒ</button>
                <button onclick="switchTab('shop')" class="btn-retro bg-green-600 text-white text-sm font-bold text-white">ìƒì  ì´ìš©</button>
            </div>
        </div>

        <!-- ë¡œìŠ¤í„° ë·° -->
        <div id="view-collection" class="fixed inset-0 bg-gray-200 z-[200] hidden p-6 overflow-y-auto text-black">
            <div class="flex justify-between items-center mb-8 pt-8 text-black">
                <div>
                    <h2 class="text-3xl font-title uppercase tracking-tighter text-black">ëª¨ë¹„ìŠ¤ ë¡œìŠ¤í„° (<span id="collected-count">0</span>/26)</h2>
                </div>
                <button onclick="closeViews()" class="bg-black text-white px-4 py-2 font-bold shadow-md">X</button>
            </div>
            <div id="player-grid" class="grid grid-cols-2 gap-4 pb-32"></div>
        </div>

        <!-- ìƒì  ë·° -->
        <div id="view-shop" class="fixed inset-0 bg-red-50 z-[200] hidden p-8 flex flex-col items-center justify-center text-black">
            <button onclick="closeViews()" class="absolute top-12 right-8 bg-black text-white px-4 py-2 font-bold shadow-md">X</button>
            <div class="bg-white border-4 border-black p-8 max-w-sm w-full text-center shadow-[12px_12px_0px_#000]">
                <h3 class="text-3xl font-title mb-4 uppercase text-black">ìŠ¤ì¹´ìš°íŠ¸ & ìƒì </h3>
                <div class="bg-gray-100 p-4 border-2 border-black mb-8 font-bold text-xl uppercase text-black text-center text-black">ë³´ìœ  MP: <span id="shop-mp" class="text-red-600">0</span></div>
                
                <div class="flex flex-col space-y-4 items-center text-black">
                    <button onclick="buyLife('shop')" class="btn-retro bg-yellow-400 text-black text-sm text-black font-bold">ìƒëª… 1ê°œ êµ¬ë§¤ (200 MP)</button>
                    <button id="shop-scout-btn" onclick="scoutPlayer('shop')" class="btn-retro bg-red-600 text-white text-sm text-white font-bold">ì„ ìˆ˜ ì˜ì… (100 MP)</button>
                </div>
            </div>
        </div>

        <div id="modal" class="fixed inset-0 bg-black/95 z-[300] flex items-center justify-center hidden p-6">
            <div id="scout-result" class="max-w-xs w-full"></div>
        </div>
    </div>

    <script>
        // --- 1. ê¸€ë¡œë²Œ í•µì‹¬ ìƒìˆ˜ ë° ë“œë¡œì‰ ìœ í‹¸ë¦¬í‹° (ReferenceError ë°©ì§€) ---
        const LANE_HEIGHT = 80;
        const GRID_SIZE = 60;
        const LEVEL_DIST = 50;
        const MAX_LIVES = 5;

        const Colors = {
            0: null, 1: "#e86a17", 2: "#000000", 3: "#332211", 4: "#ffdbac", 
            5: "#000000", 6: "#e30613", 7: "#ffffff", 8: "#ffca08",
            9: "#ffffff", 10: "#9e4300", 11: "#ffffff", 12: "#ffc0cb"
        };

        const PixelNumbers = {
            '0': [[1,1,1],[1,0,1],[1,0,1],[1,0,1],[1,1,1]],
            '1': [[0,1,0],[0,1,0],[0,1,0],[0,1,0],[0,1,0]],
            '2': [[1,1,1],[0,0,1],[1,1,1],[1,0,0],[1,1,1]],
            '3': [[1,1,1],[0,0,1],[1,1,1],[0,0,1],[1,1,1]],
            '4': [[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1]],
            '5': [[1,1,1],[1,0,0],[1,1,1],[0,0,1],[1,1,1]],
            '6': [[1,1,1],[1,0,0],[1,1,1],[1,0,1],[1,1,1]],
            '7': [[1,1,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],
            '8': [[1,1,1],[1,0,1],[1,1,1],[1,0,1],[1,1,1]],
            '9': [[1,1,1],[1,0,1],[1,1,1],[0,0,1],[1,1,1]]
        };

        const Sprites = {
            ball: [
                [0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0],[0,0,0,2,2,11,11,11,11,1,1,2,2,0,0,0],[0,0,2,11,11,11,11,1,1,1,1,1,1,2,0,0],
                [0,2,11,1,1,1,2,2,2,2,2,1,1,1,2,0],[0,2,1,1,2,11,1,1,1,1,1,2,1,1,2,0],[2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2],
                [2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2],[2,1,2,1,1,2,2,2,2,2,2,1,1,2,1,2],[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
                [2,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2],[2,1,1,2,1,1,1,1,1,1,1,1,2,1,1,2],[2,10,1,1,2,1,1,1,1,1,1,2,1,10,10,2],
                [0,2,10,10,1,2,1,1,1,1,2,1,10,10,2,0],[0,0,2,10,10,10,10,10,10,10,10,10,2,0,0],[0,0,0,2,2,10,10,10,10,10,10,2,2,0,0,0],[0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,0]
            ],
            heart: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,6,6,0,0,0,0,6,6,0,0,0,0,0],[0,0,6,6,6,6,0,0,6,6,6,6,0,0,0,0],
                [0,6,6,6,6,6,6,6,6,6,6,6,6,0,0,0],[0,6,6,6,6,6,6,6,6,6,6,6,6,0,0,0],[0,0,6,6,6,6,6,6,6,6,6,6,0,0,0,0],
                [0,0,0,6,6,6,6,6,6,6,6,0,0,0,0,0],[0,0,0,0,6,6,6,6,6,6,0,0,0,0,0],[0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,0],[0,0,0,0,0,0,6,6,0,0,0,0,0,0,0,0]
            ],
            whale: [
                [0,0,0,0,0,0,11,11,11,11,11,11,0,0,0,0],[0,0,0,11,11,11,11,11,11,11,11,11,11,11,0,0],[0,0,11,11,11,11,11,11,11,11,11,11,11,11,11,0],
                [0,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11],[0,11,11,5,5,11,11,11,11,11,11,11,11,11,11,11],[0,11,5,5,5,5,11,11,11,11,11,11,11,11,11,11],
                [11,11,11,5,5,11,11,11,11,11,11,11,11,11,11,11],[11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11],[11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11],
                [0,11,11,11,11,11,11,11,11,11,11,11,11,11,11,0],[0,0,11,11,11,11,11,11,11,11,11,11,11,11,0,0],[0,0,0,12,12,12,12,12,12,12,12,12,12,0,0,0],
                [0,0,11,11,0,0,0,0,0,0,0,11,11,0,0,0],[0,11,11,0,0,0,0,0,0,0,0,0,11,11,0,0]
            ],
            human_base: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],
                [0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,4,0,0,0,0],
                [0,0,0,0,4,4,4,2,2,4,4,4,0,0,0,0],[0,0,0,0,0,4,4,4,4,4,4,0,0,0,0],[0,0,8,6,6,6,6,6,6,6,6,6,6,8,0,0],
                [0,0,6,6,6,6,6,6,6,6,6,6,6,6,0,0],[0,0,6,6,6,6,6,6,6,6,6,6,6,6,0,0],[0,0,6,6,6,6,6,6,6,6,6,6,6,6,0,0],
                [0,0,6,6,6,6,6,6,6,6,6,6,6,6,0,0],[0,0,0,6,6,6,0,0,0,6,6,6,0,0,0,0],[0,0,0,4,4,4,0,0,0,4,4,4,0,0,0,0],[0,0,3,3,3,3,0,0,0,3,3,3,3,0,0,0]
            ]
        };

        function drawSprite(targetCtx, sprite, colors, x, y, size) {
            if (!sprite) return;
            const pixelSize = size / sprite.length;
            sprite.forEach((row, rIdx) => {
                row.forEach((cIdx, colIdx) => {
                    const color = colors[cIdx];
                    if (color) { targetCtx.fillStyle = color; targetCtx.fillRect(x + colIdx * pixelSize, y + rIdx * pixelSize, pixelSize + 0.5, pixelSize + 0.5); }
                });
            });
        }

        function drawDigit(targetCtx, digit, startX, startY, pSize) {
            const data = PixelNumbers[digit]; if (!data) return;
            data.forEach((row, rIdx) => { row.forEach((pixel, cIdx) => { if (pixel) targetCtx.fillRect(startX + cIdx * pSize, startY + rIdx * pSize, pSize, pSize); }); });
        }

        function drawCharacter(targetCtx, playerObj, x, y, size, teamColor = "#e30613", numOverride = null) {
            const pixelSize = size / 16;
            const spriteColors = {...Colors, 6: teamColor};
            if (playerObj && (playerObj.isWhale || playerObj.id === 26)) {
                drawSprite(targetCtx, Sprites.whale, Colors, x, y, size); return;
            }
            if (playerObj) { spriteColors[3] = playerObj.hair || "#332211"; spriteColors[4] = playerObj.skin || "#ffdbac"; }
            Sprites.human_base.forEach((row, rIdx) => {
                row.forEach((cIdx, colIdx) => {
                    const color = spriteColors[cIdx];
                    if (color) { targetCtx.fillStyle = color; targetCtx.fillRect(x + colIdx * pixelSize, y + rIdx * pixelSize, pixelSize + 0.5, pixelSize + 0.5); }
                });
            });
            const displayNum = numOverride || (playerObj ? playerObj.number : null);
            if (displayNum && displayNum !== "ğŸ³") {
                targetCtx.fillStyle = "white";
                const numStr = String(displayNum);
                if (numStr.length === 1) drawDigit(targetCtx, numStr[0], x + 6.5 * pixelSize, y + 10 * pixelSize, pixelSize * 0.6);
                else { drawDigit(targetCtx, numStr[0], x + 5 * pixelSize, y + 10 * pixelSize, pixelSize * 0.5); drawDigit(targetCtx, numStr[1], x + 8 * pixelSize, y + 10 * pixelSize, pixelSize * 0.5); }
            }
        }

        // --- 2. ë°ì´í„° í’€ (ì „ì²´ ëª…ë‹¨) ---
        const playerPool = [
            { id: 1, name: "ê°•í˜„ìˆ˜", number: "30", pos: "G", birth: "2024 3R 5ìˆœìœ„" },
            { id: 2, name: "ê¹€ê±´í•˜", number: "15", pos: "G", birth: "2025 ì—°ê³ " },
            { id: 3, name: "ê¹€ê·¼í˜„", number: "18", pos: "G", birth: "2023 ë“œë˜í”„íŠ¸" },
            { id: 4, name: "ê¹€ë™ì¤€", number: "5", pos: "G", birth: "2021 ë“œë˜í”„íŠ¸" },
            { id: 5, name: "ê¹€íƒœì™„", number: "24", pos: "G", birth: "2022 ë“œë˜í”„íŠ¸" },
            { id: 6, name: "í•´ë¨¼ì¦ˆ", number: "2", pos: "F", birth: "ì™¸êµ­ì„ ìˆ˜" },
            { id: 7, name: "ë°•ë¬´ë¹ˆ", number: "3", pos: "G", birth: "2023 ë“œë˜í”„íŠ¸" },
            { id: 8, name: "ë°•ì •í™˜", number: "13", pos: "G", birth: "2025 ë“œë˜í”„íŠ¸" },
            { id: 9, name: "ë°•ì¤€ì€", number: "20", pos: "F", birth: "2019 ë“œë˜í”„íŠ¸" },
            { id: 10, name: "ë°•ì¤€í˜•", number: "25", pos: "F", birth: "2024 ë“œë˜í”„íŠ¸" },
            { id: 11, name: "ì„œëª…ì§„", number: "7", pos: "G", birth: "2018 ë“œë˜í”„íŠ¸" },
            { id: 12, name: "ì´ëŒ€ê· ", number: "23", pos: "F", birth: "2024 ë“œë˜í”„íŠ¸" },
            { id: 13, name: "ì´ëŒ€í—Œ", number: "21", pos: "F", birth: "2015 ë“œë˜í”„íŠ¸" },
            { id: 14, name: "ì´ë„í—Œ", number: "19", pos: "G", birth: "2020 ë“œë˜í”„íŠ¸" },
            { id: 15, name: "ì´ìŠ¹ìš°", number: "0", pos: "F", birth: "2021 ë“œë˜í”„íŠ¸" },
            { id: 16, name: "ì´ìŠ¹í˜„", number: "33", pos: "F", birth: "2014 ë“œë˜í”„íŠ¸" },
            { id: 17, name: "ì´ìš°ì •", number: "4", pos: "G", birth: "2017 ë“œë˜í”„íŠ¸" },
            { id: 18, name: "ì „ì¤€ë²”", number: "17", pos: "F", birth: "2013 ë“œë˜í”„íŠ¸" },
            { id: 19, name: "ì •ì¤€ì›", number: "1", pos: "F", birth: "2012 ë“œë˜í”„íŠ¸" },
            { id: 20, name: "ì¡°í•œì§„", number: "9", pos: "F", birth: "2018 ë“œë˜í”„íŠ¸" },
            { id: 21, name: "ì¡´ ì´ê·¸ë¶€ëˆ„", number: "22", pos: "C", birth: "ì™¸êµ­ì„ ìˆ˜" },
            { id: 22, name: "ì¡´í‚´ì›° í”¼ê²Œë¡œì•„", number: "8", pos: "G", birth: "ì•„ì‹œì•„ì¿¼í„°" },
            { id: 23, name: "ìµœê°•ë¯¼", number: "35", pos: "G", birth: "2025 ë“œë˜í”„íŠ¸" },
            { id: 24, name: "í•¨ì§€í›ˆ", number: "12", pos: "F", birth: "2007 ë“œë˜í”„íŠ¸" },
            { id: 25, name: "ì–‘ë™ê·¼", number: "6", pos: "G", birth: "ë ˆì „ë“œ íˆì–´ë¡œ", isSpecial: true },
            { id: 26, name: "ë³„ê¹Œë£¨", number: "ğŸ³", pos: "ë§ˆìŠ¤ì½”íŠ¸", isWhale: true, isSpecial: true }
        ];

        const enemyPool = [
            // DB
            {name:"ê°•ìƒì¬", team:"ì›ì£¼ DB", number:"26", color:"#166534"},{name:"ê¹€ë³´ë°°", team:"ì›ì£¼ DB", number:"10", color:"#166534"},{name:"ê¹€íœ´ë²”", team:"ì›ì£¼ DB", number:"20", color:"#166534"},
            {name:"ë°•ë´‰ì§„", team:"ì›ì£¼ DB", number:"21", color:"#166534"},{name:"ë°•ìƒìš°", team:"ì›ì£¼ DB", number:"11", color:"#166534"},{name:"ë°•ì¸ì›…", team:"ì›ì£¼ DB", number:"23", color:"#166534"},
            {name:"ì„œë¯¼ìˆ˜", team:"ì›ì£¼ DB", number:"35", color:"#166534"},{name:"ì´ì •í˜„", team:"ì›ì£¼ DB", number:"3", color:"#166534"},{name:"ìµœì„±ì›", team:"ì›ì£¼ DB", number:"19", color:"#166534"},
            // KT
            {name:"ê°•ì„±ìš±", team:"ìˆ˜ì› KT", number:"77", color:"#111"},{name:"ê³ ì°¬í˜", team:"ìˆ˜ì› KT", number:"6", color:"#111"},{name:"ë¬¸ì„±ê³¤", team:"ìˆ˜ì› KT", number:"10", color:"#111"},
            {name:"ë¬¸ì •í˜„", team:"ìˆ˜ì› KT", number:"12", color:"#111"},{name:"ë°•ì¤€ì˜", team:"ìˆ˜ì› KT", number:"23", color:"#111"},{name:"ë°•ì§€ì›", team:"ìˆ˜ì› KT", number:"9", color:"#111"},
            {name:"í•˜ìœ¤ê¸°", team:"ìˆ˜ì› KT", number:"0", color:"#111"},{name:"í•œí¬ì›", team:"ìˆ˜ì› KT", number:"1", color:"#111"},
            // SK
            {name:"ê°•ì¬ë¯¼", team:"ì„œìš¸ SK", number:"0", color:"#dc2626"},{name:"ê¹€ê±´ìš°", team:"ì„œìš¸ SK", number:"31", color:"#dc2626"},{name:"ê¹€ë‚™í˜„", team:"ì„œìš¸ SK", number:"4", color:"#dc2626"},
            {name:"ê¹€ëª…ì§„", team:"ì„œìš¸ SK", number:"20", color:"#dc2626"},{name:"ê¹€íƒœí›ˆ", team:"ì„œìš¸ SK", number:"9", color:"#dc2626"},{name:"ê¹€í˜•ë¹ˆ", team:"ì„œìš¸ SK", number:"23", color:"#dc2626"},
            {name:"ì˜¤ì„¸ê·¼", team:"ì„œìš¸ SK", number:"41", color:"#dc2626"},{name:"ì˜¤ì¬í˜„", team:"ì„œìš¸ SK", number:"22", color:"#dc2626"},{name:"ì›Œë‹ˆ", team:"ì„œìš¸ SK", number:"34", color:"#dc2626"},
            {name:"ìµœë¶€ê²½", team:"ì„œìš¸ SK", number:"14", color:"#dc2626"},{name:"ìµœì›í˜", team:"ì„œìš¸ SK", number:"3", color:"#dc2626"},
            // ì†Œë…¸
            {name:"ê°•ì§€í›ˆ", team:"ê³ ì–‘ ì†Œë…¸", number:"12", color:"#0891b2"},{name:"ê¹€ë„ì€", team:"ê³ ì–‘ ì†Œë…¸", number:"8", color:"#0891b2"},{name:"ê¹€ì˜í›ˆ", team:"ê³ ì–‘ ì†Œë…¸", number:"24", color:"#0891b2"},
            {name:"ê¹€ì§„ìœ ", team:"ê³ ì–‘ ì†Œë…¸", number:"55", color:"#0891b2"},{name:"ë‚˜ì´íŠ¸", team:"ê³ ì–‘ ì†Œë…¸", number:"1", color:"#0891b2"},{name:"ë¬¸ì‹œìœ¤", team:"ê³ ì–‘ ì†Œë…¸", number:"20", color:"#0891b2"},
            {name:"ì´ì¬ë„", team:"ê³ ì–‘ ì†Œë…¸", number:"4", color:"#0891b2"},{name:"ì´ì •í˜„", team:"ê³ ì–‘ ì†Œë…¸", number:"6", color:"#0891b2"},{name:"ì„ë™ì„­", team:"ê³ ì–‘ ì†Œë…¸", number:"13", color:"#0891b2"},
            // KCC
            {name:"ê°•íƒœí˜„", team:"ë¶€ì‚° KCC", number:"27", color:"#001a4d"},{name:"ê¹€ë™í˜„", team:"ë¶€ì‚° KCC", number:"5", color:"#001a4d"},{name:"ê¹€ìœ¤ì„±", team:"ë¶€ì‚° KCC", number:"14", color:"#001a4d"},
            {name:"ê¹€í›ˆ", team:"ë¶€ì‚° KCC", number:"12", color:"#001a4d"},{name:"ì†¡êµì°½", team:"ë¶€ì‚° KCC", number:"9", color:"#001a4d"},{name:"ìˆ€ ë¡±", team:"ë¶€ì‚° KCC", number:"36", color:"#001a4d"},
            {name:"ìµœì¤€ìš©", team:"ë¶€ì‚° KCC", number:"2", color:"#001a4d"},{name:"í—ˆì›…", team:"ë¶€ì‚° KCC", number:"3", color:"#001a4d"},{name:"í—ˆí›ˆ", team:"ë¶€ì‚° KCC", number:"7", color:"#001a4d"},
            // LG
            {name:"ê¹€ì„ ìš°", team:"ì°½ì› LG", number:"24", color:"#800000"},{name:"ë‘ê²½ë¯¼", team:"ì°½ì› LG", number:"30", color:"#800000"},{name:"ë°•ì •í˜„", team:"ì°½ì› LG", number:"31", color:"#800000"},
            {name:"ì–‘ì¤€ì„", team:"ì°½ì› LG", number:"5", color:"#800000"},{name:"ì–‘í™ì„", team:"ì°½ì› LG", number:"4", color:"#800000"},{name:"ìœ ê¸°ìƒ", team:"ì°½ì› LG", number:"1", color:"#800000"},
            {name:"ìœ¤ì›ìƒ", team:"ì°½ì› LG", number:"10", color:"#800000"},{name:"í•œìƒí˜", team:"ì°½ì› LG", number:"6", color:"#800000"},{name:"í—ˆì¼ì˜", team:"ì°½ì› LG", number:"11", color:"#800000"},
            // ì •ê´€ì¥
            {name:"ê¹€ê²½ì›", team:"ì•ˆì–‘ ì •ê´€", number:"17", color:"#991b1b"},{name:"ê¹€ì„¸ì°½", team:"ì•ˆì–‘ ì •ê´€", number:"2", color:"#991b1b"},{name:"ê¹€ì¢…ê·œ", team:"ì•ˆì–‘ ì •ê´€", number:"15", color:"#991b1b"},
            {name:"ì•„ë°˜ë„", team:"ì•ˆì–‘ ì •ê´€", number:"10", color:"#991b1b"},{name:"ë°•ì§€í›ˆ", team:"ì•ˆì–‘ ì •ê´€", number:"6", color:"#991b1b"},{name:"ë³€ì¤€í˜•", team:"ì•ˆì–‘ ì •ê´€", number:"5", color:"#991b1b"},
            {name:"ì •íš¨ê·¼", team:"ì•ˆì–‘ ì •ê´€", number:"12", color:"#991b1b"},
            // ê°€ìŠ¤ê³µì‚¬
            {name:"ê¶Œìˆœìš°", team:"ê°€ìŠ¤ê³µì‚¬", number:"17", color:"#0066cc"},{name:"ê¹€êµ­ì°¬", team:"ê°€ìŠ¤ê³µì‚¬", number:"30", color:"#0066cc"},{name:"ë¼ê±´ì•„", team:"ê°€ìŠ¤ê³µì‚¬", number:"20", color:"#0066cc"},
            {name:"ë²¨ë€ê²”", team:"ê°€ìŠ¤ê³µì‚¬", number:"0", color:"#0066cc"},{name:"ì‹ ìŠ¹ë¯¼", team:"ê°€ìŠ¤ê³µì‚¬", number:"2", color:"#0066cc"},{name:"ì°¨ë°”ìœ„", team:"ê°€ìŠ¤ê³µì‚¬", number:"6", color:"#0066cc"},
            {name:"ìµœì°½ì§„", team:"ê°€ìŠ¤ê³µì‚¬", number:"4", color:"#0066cc"},
            // ì‚¼ì„±
            {name:"ê¹€í•œì†”", team:"ì„œìš¸ ì‚¼ì„±", number:"71", color:"#1e3a8a"},{name:"ë°•ìŠ¹ì¬", team:"ì„œìš¸ ì‚¼ì„±", number:"3", color:"#1e3a8a"},{name:"ì´ê´€í¬", team:"ì„œìš¸ ì‚¼ì„±", number:"11", color:"#1e3a8a"},
            {name:"ì´ëŒ€ì„±", team:"ì„œìš¸ ì‚¼ì„±", number:"43", color:"#1e3a8a"},{name:"ì´ì›ì„", team:"ì„œìš¸ ì‚¼ì„±", number:"2", color:"#1e3a8a"},{name:"í•œí˜¸ë¹ˆ", team:"ì„œìš¸ ì‚¼ì„±", number:"5", color:"#1e3a8a"},
            {name:"í™©ì˜ì°¬", team:"ì„œìš¸ ì‚¼ì„±", number:"16", color:"#1e3a8a"}
        ];

        // --- 4. Game Logic State ---
        let totalMP = parseInt(localStorage.getItem('mobis_v30_mp')) || 100;
        let myCollection = new Set(JSON.parse(localStorage.getItem('mobis_v30_col')) || []);
        let selectedPlayerId = parseInt(localStorage.getItem('mobis_v30_selected')) || null;
        let bestDist = parseInt(localStorage.getItem('mobis_v30_best')) || 0;

        let lives = 3, invulnerable = 0, currentLevel = 1, gameState = 'START', score = 0, earnedMP = 0, shotClock = 100;
        let cameraY = 0, lanes = [], player = { lane: 0, x: 0, targetX: 0, currentX: 0 };
        let animationFrameId = null;

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // --- 5. ë¡œì§ í•¨ìˆ˜ ---
        function initPlayerPos() {
            player.x = Math.floor(canvas.width / 2 / GRID_SIZE) * GRID_SIZE;
            player.targetX = player.x; player.currentX = player.x;
            player.lane = 0; cameraY = 0;
        }

        function resize() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            initPlayerPos(); renderPreview(); renderLives(); updateStartUI();
        }
        window.addEventListener('resize', resize);

        function renderPreview() {
            const pCtx = document.getElementById('preview-canvas').getContext('2d');
            pCtx.clearRect(0,0,80,80);
            const sel = playerPool.find(p => p.id === selectedPlayerId);
            if (sel) drawCharacter(pCtx, sel, 0, 0, 80);
            else drawSprite(pCtx, Sprites.ball, Colors, 0, 0, 80);
        }

        function renderLives() {
            const container = document.getElementById('lives-bar'); container.innerHTML = '';
            for(let i=0; i<lives; i++) {
                const cvs = document.createElement('canvas'); cvs.width = 24; cvs.height = 24;
                drawSprite(cvs.getContext('2d'), Sprites.heart, Colors, 0, 0, 24);
                container.appendChild(cvs);
            }
        }

        function updateStartUI() {
            document.getElementById('best-dist').innerText = bestDist;
            document.getElementById('collect-count-display').innerText = `ë¡œìŠ¤í„° ìˆ˜ì§‘: ${myCollection.size}/26`;
        }

        function addLane(index) {
            let type = 'safe', color = index % 10 === 0 ? '#b27732' : (index % 2 === 0 ? '#d29145' : '#de9b42'), objects = [];
            if (index > 0 && index % LEVEL_DIST === 0) {
                type = 'goal'; color = '#e30613'; objects.push({ x: canvas.width / 2, type: 'hoop' });
            } else if (index > 2) {
                const speedFactor = 1 + (currentLevel * 0.45); 
                const enemyCount = Math.min(3, 1 + Math.floor(currentLevel / 4)); 
                if (Math.random() > 0.4) { 
                    type = 'road'; color = '#4a4a4a'; 
                    for(let i=0; i<enemyCount; i++) {
                        const enemy = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                        const speed = (Math.random() * 1.5 + 1.5) * (Math.random() > 0.5 ? 1 : -1) * speedFactor;
                        objects.push({ x: Math.random() * canvas.width, speed: speed, team: enemy.team, name: enemy.name, number: enemy.number, color: enemy.color });
                    }
                } else if (Math.random() > 0.75) {
                    objects.push({ x: Math.floor(Math.random() * (canvas.width / GRID_SIZE)) * GRID_SIZE + (GRID_SIZE / 2), type: (Math.random() > 0.4 ? 'item' : 'coin') });
                }
            }
            lanes.push({ type, color, objects, index });
        }

        function startGame() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            document.querySelectorAll('.overlay, .view').forEach(o => o.classList.add('hidden'));
            gameState = 'PLAYING'; score = 0; earnedMP = 0; shotClock = 100; currentLevel = 1; lives = 3; invulnerable = 0;
            lanes = []; for(let i=0; i<30; i++) addLane(i);
            initPlayerPos(); updateUI(); renderLives(); gameLoop();
        }

        function togglePause() {
            if (gameState === 'PLAYING') { gameState = 'PAUSED'; document.getElementById('overlay-pause').classList.remove('hidden'); }
            else if (gameState === 'PAUSED') { gameState = 'PLAYING'; document.getElementById('overlay-pause').classList.add('hidden'); gameLoop(); }
        }

        function gameOver(reason) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameState = 'OVER'; totalMP += earnedMP; if (score > bestDist) bestDist = score;
            saveGameData();
            document.getElementById('overlay-over').classList.remove('hidden');
            document.getElementById('final-stats').innerHTML = `STAGE: LV.${currentLevel}<br>DIST: ${score}m<br>REWARD: +${earnedMP} MP<br>BEST: ${bestDist}m<br><br><span style="color:#ffca08;">${reason}</span>`;
            updateUI();
        }

        function levelUp() { gameState = 'QUIZ'; totalMP += earnedMP; saveGameData(); showQuiz(); }

        function showQuiz() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            const feedback = document.getElementById('quiz-feedback'); feedback.classList.add('hidden');
            document.getElementById('quiz-next-btn').classList.add('hidden');
            const mobisPlayers = playerPool.filter(p => !p.isWhale);
            const target = mobisPlayers[Math.floor(Math.random() * mobisPlayers.length)];
            document.getElementById('quiz-question').innerHTML = `No.<span style="color:#e30613; font-weight:900;">${target.number}</span> ì„ ìˆ˜ì˜ ì´ë¦„ì€?`;
            let options = [target.name]; while(options.length < 4) {
                const rand = mobisPlayers[Math.floor(Math.random() * mobisPlayers.length)].name;
                if(!options.includes(rand)) options.push(rand);
            }
            options.sort(() => Math.random() - 0.5);
            const container = document.getElementById('quiz-options'); container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button'); btn.className = 'quiz-option font-title';
                btn.innerText = opt; btn.onclick = () => checkQuiz(opt, target.name);
                container.appendChild(btn);
            });
            document.getElementById('overlay-quiz').classList.remove('hidden');
        }

        function checkQuiz(selected, correct) {
            const feedback = document.getElementById('quiz-feedback'); const nextBtn = document.getElementById('quiz-next-btn');
            document.querySelectorAll('.quiz-option').forEach(b => b.disabled = true);
            feedback.classList.remove('hidden'); nextBtn.classList.remove('hidden');
            if (selected === correct) { totalMP += 50; feedback.innerText = "ì •ë‹µì…ë‹ˆë‹¤! (+50 MP)"; feedback.style.color = "#16a34a"; }
            else { feedback.innerText = `ì˜¤ë‹µ! ì •ë‹µì€ ${correct} ì„ ìˆ˜ì…ë‹ˆë‹¤.`; feedback.style.color = "#dc2626"; }
            saveGameData(); updateUI();
        }

        function moveToClearScreen() {
            document.getElementById('overlay-quiz').classList.add('hidden'); gameState = 'LEVEL_CLEAR';
            document.getElementById('overlay-clear').classList.remove('hidden');
            document.getElementById('clear-stats').innerText = `STAGE ${currentLevel} CLEAR!\nBONUS: +50 MP`;
            totalMP += 50; saveGameData(); updateUI();
        }

        function continueGame() {
            currentLevel++; earnedMP = 0; shotClock = 100;
            document.getElementById('overlay-clear').classList.add('hidden');
            document.getElementById('game-container').classList.add('goal-effect');
            setTimeout(() => document.getElementById('game-container').classList.remove('goal-effect'), 500);
            gameState = 'PLAYING'; gameLoop();
        }

        function moveForward() {
            if (gameState !== 'PLAYING') return;
            player.lane++; score = player.lane; earnedMP++; shotClock = 100;
            if (player.lane > 0 && player.lane % LEVEL_DIST === 0) levelUp();
            if (lanes.length < player.lane + 20) addLane(lanes.length);
            updateUI();
        }

        function moveSide(dir) {
            if (gameState !== 'PLAYING') return;
            const newX = player.targetX + (dir * GRID_SIZE);
            if (newX >= 0 && newX < canvas.width - GRID_SIZE) player.targetX = newX;
        }

        // ì œìŠ¤ì²˜ ì¡°ì‘
        let tSX = 0, tSY = 0;
        window.addEventListener('touchstart', (e) => { if (gameState === 'PLAYING') { tSX = e.touches[0].clientX; tSY = e.touches[0].clientY; } });
        window.addEventListener('touchend', (e) => {
            if (gameState !== 'PLAYING') return;
            let dx = e.changedTouches[0].clientX - tSX; let dy = e.changedTouches[0].clientY - tSY;
            if (dy < -30 && Math.abs(dy) > Math.abs(dx)) moveForward();
            else if (Math.abs(dx) > 30 && Math.abs(dx) > Math.abs(dy)) moveSide(dx > 0 ? 1 : -1);
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowUp' || e.code === 'Space') moveForward();
            if (e.code === 'ArrowLeft') moveSide(-1);
            if (e.code === 'ArrowRight') moveSide(1);
            if (e.code === 'Escape') togglePause();
        });

        function buyLife(source) {
            if (totalMP >= 200) { 
                if (lives >= MAX_LIVES) {
                    alert("ì´ë¯¸ ìµœëŒ€ ìƒëª…(5ê°œ)ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!");
                    return;
                }
                totalMP -= 200; lives++; saveGameData(); updateUI(); renderLives(); 
                alert("ìƒëª… 1ê°œë¥¼ ì¶©ì „í–ˆìŠµë‹ˆë‹¤! â¤ï¸ (í˜„ì¬ ìƒëª…: " + lives + "ê°œ)");
            } else {
                alert("MPê°€ ëª¨ìëë‹ˆë‹¤! (200 MP í•„ìš”)");
            }
        }

        function gameLoop() {
            if (gameState !== 'PLAYING') return;
            shotClock -= 0.17; document.getElementById('shot-clock-inner').style.width = shotClock + '%';
            
            if (shotClock <= 0) { 
                lives--; renderLives();
                if (lives <= 0) { gameOver('ê³µê²© ì œí•œ ì‹œê°„ ì´ˆê³¼'); return; }
                else {
                    shotClock = 100;
                    document.getElementById('game-container').classList.add('hit-effect');
                    setTimeout(() => document.getElementById('game-container').classList.remove('hit-effect'), 400);
                    updateUI();
                }
            }
            
            if (invulnerable > 0) invulnerable--;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            cameraY += (player.lane * LANE_HEIGHT - cameraY) * 0.1;

            lanes.forEach(lane => {
                const sY = (canvas.height - 250) + (cameraY - lane.index * LANE_HEIGHT);
                if (sY < -LANE_HEIGHT || sY > canvas.height + LANE_HEIGHT) return;
                ctx.fillStyle = lane.color; ctx.fillRect(0, sY, canvas.width, LANE_HEIGHT);
                ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.strokeRect(0, sY, canvas.width, LANE_HEIGHT);
                lane.objects.forEach((obj, idx) => {
                    if (lane.type === 'road') {
                        obj.x += obj.speed; if (obj.x > canvas.width + 100) obj.x = -150; if (obj.x < -150) obj.x = canvas.width + 100;
                        drawCharacter(ctx, null, obj.x, sY + 5, 60, obj.color, obj.number);
                        ctx.fillStyle = 'rgba(0,0,0,0.6)'; const lbl = `[${obj.team}] ${obj.name}`; const lw = ctx.measureText(lbl).width + 12;
                        ctx.fillRect(obj.x + 30 - lw/2, sY + 68, lw, 14);
                        ctx.fillStyle = 'white'; ctx.font = '900 10px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(lbl, obj.x + 30, sY + 79);
                        if (invulnerable === 0 && player.lane === lane.index && player.currentX + 40 > obj.x && player.currentX + 20 < obj.x + 60) {
                            lives--; renderLives();
                            if (lives <= 0) gameOver(`${obj.team} ${obj.name} ë¸”ë½!`);
                            else { invulnerable = 60; document.getElementById('game-container').classList.add('hit-effect'); setTimeout(() => document.getElementById('game-container').classList.remove('hit-effect'), 400); updateUI(); }
                        }
                    } else if (obj.type === 'item' || obj.type === 'coin') {
                        const s = obj.type === 'item' ? Sprites.ball : Sprites.coin; const sz = obj.type === 'item' ? 30 : 24;
                        drawSprite(ctx, s, Colors, obj.x - sz/2, sY + LANE_HEIGHT/2 - sz/2, sz);
                        if (player.lane === lane.index && Math.abs(player.currentX + 30 - obj.x) < 30) { lane.objects.splice(idx, 1); earnedMP += (obj.type === 'item' ? 10 : 5); updateUI(); }
                    } else if (obj.type === 'hoop') drawSprite(ctx, Sprites.hoop, Colors, obj.x - 40, sY + 5, 80);
                });
            });
            player.currentX += (player.targetX - player.currentX) * 0.2;
            const jY = Math.sin((Math.abs(player.lane * LANE_HEIGHT - cameraY) / LANE_HEIGHT) * Math.PI) * 50;
            const dY = (canvas.height - 250) - jY;
            const sel = playerPool.find(p => p.id === selectedPlayerId);
            ctx.save(); if (invulnerable > 0 && Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.3;
            if (sel) drawCharacter(ctx, sel, player.currentX, dY, 60); else drawSprite(ctx, Sprites.ball, Colors, player.currentX, dY, 60);
            ctx.restore(); animationFrameId = requestAnimationFrame(gameLoop);
        }

        function updateUI() {
            document.getElementById('current-score').innerText = score; document.getElementById('current-level').innerText = currentLevel;
            document.getElementById('total-mp-display').innerText = totalMP + earnedMP; document.getElementById('shop-mp').innerText = totalMP;
            const cc = document.getElementById('collected-count'); if(cc) cc.innerText = myCollection.size;
        }

        function saveGameData() {
            localStorage.setItem('mobis_v30_mp', totalMP); localStorage.setItem('mobis_v30_col', JSON.stringify([...myCollection]));
            localStorage.setItem('mobis_v30_selected', selectedPlayerId); localStorage.setItem('mobis_v30_best', bestDist);
        }

        function switchTab(tab) {
            document.querySelectorAll('.view, .overlay').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            if (tab === 'collection') renderCollection(); updateUI();
        }

        function closeViews() {
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            if (gameState === 'START') document.getElementById('overlay-start').classList.remove('hidden');
            else if (gameState === 'OVER') document.getElementById('overlay-over').classList.remove('hidden');
            else if (gameState === 'LEVEL_CLEAR') document.getElementById('overlay-clear').classList.remove('hidden');
            renderPreview(); updateStartUI();
        }

        function scoutPlayer() {
            const avail = playerPool.filter(p => !myCollection.has(p.id));
            if (totalMP < 100) { alert("MPê°€ ëª¨ìëë‹ˆë‹¤!"); return; }
            if (avail.length === 0) { alert("ì´ë¯¸ ëª¨ë“  ì „ì›ì„ ì˜ì…í–ˆìŠµë‹ˆë‹¤!"); return; }
            totalMP -= 100; const p = avail[Math.floor(Math.random() * avail.length)];
            myCollection.add(p.id); saveGameData(); showProfileCard(p); updateUI();
        }

        function showProfileCard(p) {
            const modal = document.getElementById('modal'), res = document.getElementById('scout-result');
            modal.classList.remove('hidden');
            res.innerHTML = `<div class="profile-card p-6 text-center">
                <div class="bg-black p-2 mb-4 border-2 border-black"><canvas id="result-canvas" width="128" height="128" class="mx-auto bg-white"></canvas></div>
                <div class="font-title text-2xl mb-1 tracking-tighter text-black">#${p.number} ${p.name}</div>
                <div class="text-[10px] font-bold text-gray-500 mb-4 uppercase">Ulsan Hyundai Mobis</div>
                <button onclick="document.getElementById('modal').classList.add('hidden')" class="btn-retro bg-black text-white w-full py-4 font-bold text-sm mx-auto" style="width:100%; box-shadow:none;">í™•ì¸</button>
            </div>`;
            drawCharacter(document.getElementById('result-canvas').getContext('2d'), p, 0, 0, 128);
        }

        function renderCollection() {
            const grid = document.getElementById('player-grid'); grid.innerHTML = '';
            const sorted = [...playerPool].sort((a, b) => {
                if (a.number === "ğŸ³") return 1; if (b.number === "ğŸ³") return -1;
                return parseInt(a.number) - parseInt(b.number);
            });
            sorted.forEach(p => {
                const owned = myCollection.has(p.id), isSel = selectedPlayerId === p.id, cId = `card-p-${p.id}`;
                grid.innerHTML += `<div onclick="${owned ? `selectPlayerFromRoster(${p.id})` : ''}" 
                    class="profile-card p-2 text-center transition-transform active:scale-95 ${owned ? 'cursor-pointer' : 'opacity-40 grayscale'} ${isSel ? 'border-yellow-400 bg-yellow-50' : 'border-black'}">
                    <canvas id="${cId}" width="64" height="64" class="mx-auto mb-2 bg-white border-2 border-black shadow-sm"></canvas>
                    <div class="font-bold text-[12px] truncate text-black">${owned ? p.name : '???'}</div>
                    <div class="text-[9px] font-bold text-black">#${p.number}</div>
                </div>`;
            });
            setTimeout(() => { sorted.forEach(p => {
                const cvs = document.getElementById(`card-p-${p.id}`);
                if (cvs) drawCharacter(cvs.getContext('2d'), p, 0, 0, 64);
            }); }, 50);
        }

        function selectPlayerFromRoster(id) { selectedPlayerId = id; saveGameData(); renderCollection(); renderPreview(); }

        function resetGame() {
            startGame();
        }

        window.onload = resize;
    </script>
</body>
</html>